<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Incharge Dashboard - Smart Bus Attendance</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header with Profile -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-info">
                    <h1>Bus Incharge Dashboard</h1>
                    <p>Welcome, <strong>{{ incharge_name }}</strong> | Bus: <strong>{{ bus_number }}</strong> üöå</p>
                </div>
                
                <!-- Profile Icon -->
                <div class="profile-section">
                    <div class="profile-icon" onclick="toggleProfileMenu()">
                        üë§
                    </div>
                    <div id="profile-menu" class="profile-menu">
                        <a href="{{ url_for('incharge_edit_profile') }}" class="profile-menu-item">
                            <span>‚úèÔ∏è</span> Edit Profile
                        </a>
                        <a href="{{ url_for('incharge_change_password') }}" class="profile-menu-item">
                            <span>üîí</span> Change Password
                        </a>
                        <div class="profile-menu-divider"></div>
                        <a href="{{ url_for('download_attendance_excel') }}" class="profile-menu-item">
                            <span>üì•</span> Download Excel
                        </a>
                        <div class="profile-menu-divider"></div>
                        <a href="{{ url_for('logout') }}" class="profile-menu-item logout">
                            <span>üö™</span> Logout
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Face Scanning Section -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2>üì∑ Face Recognition Attendance</h2>
                <span class="last-updated">Live Camera</span>
            </div>
            
            <div class="scanning-section">
                <div class="camera-container">
                    <div class="camera-preview" id="cameraPreview">
                        <video id="video" width="100%" height="300" autoplay playsinline></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                        <div class="camera-overlay">
                            <div class="face-guide"></div>
                            <p>Position face within frame</p>
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button id="startCamera" class="btn btn-primary" onclick="startCamera()">
                            üì∏ Start Camera
                        </button>
                        <button id="captureBtn" class="btn btn-success" onclick="captureFace()" style="display: none;">
                            ‚úÖ Scan & Mark Attendance
                        </button>
                        <button id="retakeBtn" class="btn btn-secondary" onclick="retakePhoto()" style="display: none;">
            </div>
        </div>

        <!-- Today's Attendance Summary -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2>üìä Today's Attendance Summary</h2>
                <span class="view-all">{{ current_date }}</span>
            </div>
            
            <div class="attendance-stats">
                <div class="stat-card-large">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-content">
                        <h3>Total Students</h3>
                        <p class="stat-number" id="totalStudents">0</p>
                    </div>
                </div>
                
                <div class="stat-card-large">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <h3>Present Today</h3>
                        <p class="stat-number present-count" id="presentCount">0</p>
                    </div>
                </div>
                
                <div class="stat-card-large">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-content">
                        <h3>Remaining</h3>
                        <p class="stat-number" id="remainingCount">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Attendance Records -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2>üïí Recent Scans</h2>
                <button class="btn btn-outline" onclick="downloadExcel()">üì• Download Excel</button>
            </div>
            
            <div class="attendance-table-container">
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Roll Number</th>
                            <th>Status</th>
                            <th>Time</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        {% for record in attendance_records %}
                        <tr>
                            <td>{{ record.name }}</td>
                            <td>{{ record.roll_number }}</td>
                            <td>
                                <span class="status-badge status-present">Present</span>
                            </td>
                            <td>{{ record.marked_at }}</td>
                            <td>
                                <span class="confidence-level high">98%</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="action-btn" onclick="downloadExcel()">
                <span>üì•</span>
                Download Excel Report
            </button>
            <button class="action-btn" onclick="clearTodayAttendance()">
                <span>üîÑ</span>
                Reset Today's Data
            </button>
            <button class="action-btn" onclick="viewAllStudents()">
                <span>üë•</span>
                View All Students
            </button>
        </div>
    </div>

    <!-- Scan Result Modal -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Attendance Result</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Result content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <script>
        // Camera and Face Scanning Functionality
        let stream = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'environment'
                    } 
                });
                video.srcObject = stream;
                document.getElementById('startCamera').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'inline-block';
            } catch (err) {
                showResult('error', 'Camera access denied. Please allow camera permissions.');
            }
        }

        function captureFace() {
            // Draw video frame to canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to blob and send to server
            canvas.toBlob(blob => {
                markAttendance(blob);
            }, 'image/jpeg', 0.8);
        }

        function retakePhoto() {
            document.getElementById('captureBtn').style.display = 'inline-block';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('scanResult').style.display = 'none';
        }

        async function markAttendance(photoBlob) {
            const formData = new FormData();
            formData.append('photo', photoBlob, 'face_scan.jpg');
            formData.append('bus_number', '{{ bus_number }}');

            showResult('info', 'üîç Scanning face... Please wait');

            try {
                const response = await fetch('/mark_attendance', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('success', 
                        `‚úÖ Attendance marked for ${result.student_name} (${result.roll_number})<br>
                         <small>Confidence: ${(result.confidence * 100).toFixed(1)}%</small>`
                    );
                    updateAttendanceTable(result);
                    updateStats();
                } else {
                    showResult('error', 
                        `‚ùå ${result.message}<br>
                         <small>Please ensure clear face visibility</small>`
                    );
                }
            } catch (error) {
                showResult('error', 'Network error. Please try again.');
            }
        }

        function showResult(type, message) {
            const modal = document.getElementById('resultModal');
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = `
                <div class="result-${type}">
                    <div class="result-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : 'üîç'}</div>
                    <div class="result-message">${message}</div>
                </div>
            `;
            
            modal.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 3000);
            }
        }

        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        function updateAttendanceTable(result) {
            const tbody = document.getElementById('attendanceTableBody');
            const now = new Date().toLocaleTimeString();
            
            const newRow = `
                <tr>
                    <td>${result.student_name}</td>
                    <td>${result.roll_number}</td>
                    <td><span class="status-badge status-present">Present</span></td>
                    <td>${now}</td>
                    <td><span class="confidence-level high">${(result.confidence * 100).toFixed(1)}%</span></td>
                </tr>
            `;
            
            tbody.insertAdjacentHTML('afterbegin', newRow);
        }

        function updateStats() {
            // Update present count
            const presentCount = document.querySelectorAll('.status-present').length;
            document.getElementById('presentCount').textContent = presentCount;
            
            // Update remaining count (you would get total from server)
            const totalStudents = 45; // This should come from server
            document.getElementById('remainingCount').textContent = totalStudents - presentCount;
        }

        function downloadExcel() {
            showResult('info', 'üì• Preparing Excel download...');
            // This would call your backend Excel generation endpoint
            window.location.href = '/download_attendance_excel';
        }

        // Initialize stats on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
        });

        // Profile menu functionality (same as student dashboard)
        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu');
            menu.classList.toggle('active');
        }

        document.addEventListener('click', function(event) {
            const profileSection = document.querySelector('.profile-section');
            const profileMenu = document.getElementById('profile-menu');
            
            if (!profileSection.contains(event.target)) {
                profileMenu.classList.remove('active');
            }
        });
    </script>
</body>
</html>